# apiVersion: networking.istio.io/v1beta1
# kind: VirtualService
# metadata:
#   name: catalog-vsvc
#   namespace: demo
# spec:
#   gateways:
#     - catalog-gateway
#   hosts:
#     - "api.localdev.me"
#   http:
#     # - name: catalog-canary-debug
#     #   match:
#     #     - uri:
#     #         prefix: /catalog
#     #       headers:
#     #         x-canary:
#     #           exact: "true"
#     #   rewrite:
#     #     uri: "/"
#     #   route:
#     #     - destination:
#     #         host: catalog-canary
#     #         port:
#     #           number: 3001

#     - name: catalog-route
#       match:
#         - uri:
#             prefix: "/catalog"
#         - uri:
#             exact: "/catalog"
#       rewrite:
#         uri: "/"
#       route:
#         - destination:
#             host: catalog-stable
#             port:
#               number: 3001
#           weight: 100
#         - destination:
#             host: catalog-canary
#             port:
#               number: 3001
#           weight: 0
#       corsPolicy:
#         allowOrigin:
#           - "http://frontend.localdev.me"
#         allowMethods:
#           - GET
#           - POST
#           - PUT
#           - DELETE
#         allowHeaders:
#           - "*"
#         maxAge: 24h



apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: catalog-vsvc
  namespace: demo
spec:
  hosts:
    - "api.localdev.me"
  gateways:
    - catalog-gateway
  http:
    # Auth route (already exists)
    # - name: auth-route
    #   match:
    #     - uri:
    #         prefix: "/auth/"
    #     - uri:
    #         exact: "/auth"
    #   rewrite:
    #     uri: "/"
    #   corsPolicy:
    #     allowOrigins:
    #       - exact: "http://frontend.localdev.me"
    #     allowMethods: ["GET", "POST", "OPTIONS"]
    #     allowHeaders: ["*"]
    #     allowCredentials: true
    #     maxAge: "1h"
    #   route:
    #     - destination:
    #         host: auth.mv100.svc.cluster.local
    #         port:
    #           number: 3000
    #       weight: 100
    #     - destination:
    #         host: auth-canary.mv100.svc.cluster.local
    #         port:
    #           number: 3000
    #       weight: 0

    # Catalog route
    - name: catalog-route
      match:
        - uri:
            prefix: "/catalog/"
        - uri:
            exact: "/catalog"
      rewrite:
        uri: "/"
      corsPolicy:
        allowOrigins:
          - exact: "http://frontend.localdev.me"
        allowMethods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
        allowHeaders: ["*"]
        allowCredentials: true
        maxAge: "1h"
      route:
        - destination:
            host: catalog-stable
            port:
              number: 3001
          weight: 100
        - destination:
            host: catalog-canary
            port:
              number: 3001
          weight: 0
#     - name: cart-route
#       match:
#         - uri:
#             prefix: "/cart/"
#         - uri:
#             exact: "/cart"
#       rewrite:
#         uri: "/"           # strip /cart prefix
#       corsPolicy:
#         allowOrigins:
#           - exact: "http://frontend.localdev.me"
#         allowMethods:
#           - GET
#           - POST
#           - OPTIONS
#           - PUT
#           - DELETE
#         allowHeaders:
#           - "*"
#         allowCredentials: true
#         maxAge: "1h"
#       route:
#         - destination:
#             host: cart.mv100.svc.cluster.local
#             port:
#               number: 3002
#           weight: 100
#         - destination:
#             host: cart-canary.mv100.svc.cluster.local
#             port:
#               number: 3002
#           weight: 0
#     - name: orders-route
#       match:
#         - uri:
#             prefix: "/orders/"
#         - uri:
#             exact: "/orders"
# #      rewrite:
# #        uri: "/"           # strip /orders prefix
#       corsPolicy:
#         allowOrigins:
#           - exact: "http://frontend.localdev.me"
#         allowMethods:
#           - GET
#           - POST
#           - OPTIONS
#           - PUT
#           - DELETE
#         allowHeaders:
#           - "*"
#         allowCredentials: true
#         maxAge: "1h"
#       route:
#         - destination:
#             host: orders.mv100.svc.cluster.local
#             port:
#               number: 3003
#           weight: 100
#         - destination:
#             host: orders-canary.mv100.svc.cluster.local
#             port:
#               number: 3003
#           weight: 0
#     - name: payments-route
#       match:
#         - uri:
#             prefix: "/payments/"
#         - uri:
#             exact: "/payments"
# #      rewrite:
# #        uri: "/"           # strip /payments prefix
#       corsPolicy:
#         allowOrigins:
#           - exact: "http://frontend.localdev.me"
#         allowMethods:
#           - GET
#           - POST
#           - OPTIONS
#           - PUT
#           - DELETE
#         allowHeaders:
#           - "*"
#         allowCredentials: true
#         maxAge: "1h"
#       route:
#         - destination:
#             host: payments.mv100.svc.cluster.local
#             port:
#               number: 3004
#           weight: 100
#         - destination:
#             host: payments-canary.mv100.svc.cluster.local
#             port:
#               number: 3004
#           weight: 0